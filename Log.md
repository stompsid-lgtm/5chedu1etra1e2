# Log.md — 開發紀錄

## 已解決問題

### [圖片來源] 初次解析錯誤（c08 / c13 / c14）
**問題**：圖片診所（正陽骨科、悅滿意永和、悅滿意新店）的 sessions 錯誤，包含不在 whitelist 的醫師，且有命名錯誤。

**根本原因**：
- whitelist 過濾邏輯未在首次轉錄時執行，導致非 whitelist 醫師（蘇哲惟、曾鵬文、林醫師等）混入 sessions
- OCR 識別錯誤：c14 週三早診「羅醫師」被識別為「雞醫師」
- 悅滿意命名規則（`悅滿意江`/`悅滿意王`）中途被錯誤改為一般格式（`江醫師`/`王醫師`），導致 whitelist 比對失效

**修正**：2026-02-18 逐格重新對照圖片，刪除非 whitelist sessions，補上缺漏的週六時段，還原命名規則。

**教訓**：圖片轉錄時必須同步執行 whitelist 過濾；命名規則變更前需確認 whitelist 字串一致性。

---

### [資料衝突] 蔡馥如「週三夜診」衝突（c03 富新 vs c08 正陽）
**問題**：舊紀錄顯示蔡馥如同時出現在富新骨科（cxms）與正陽骨科（圖片）的週三夜診。

**結論**：誤讀。正陽骨科圖片中蔡馥如的班表是**週四**（下午二診＋夜間二診），不是週三。衝突不存在。

---

### [c08 whitelist] 曾鵬文誤入 whitelist
**問題**：schedules.json 的 c08 clinic 定義中，whitelist 包含 `曾鵬文`，但 CSV 來源只有 `黃英庭|黃旭東|蔡馥如`。

**修正**：2026-02-18 從 whitelist 移除 `曾鵬文`。

---

### [力康骨科] 重複時段
**問題**：力康骨科（c20）出現重複 session。

**修正**：已於上週對話修正，目前版本無重複。

---

### [c11 土城維力] OCR 錯字 + 幽靈醫師
**問題**：sessions 中「張善魁」全部應為「張晉魁」（OCR 錯字）。另有「林茂森」、「陳奕成」兩位完全不在圖片班表中。

**根本原因**：首次轉錄時 OCR 將「晉」識別為「善」；林茂森/陳奕成來源不明（可能是舊週或板橋維力資料混入）。

**圖片位置**：`weili-clinic.com/sites/default/files/inline-images/分頁-門診表_土城_0.png`（固定班表，115年起，同頁面另有板橋維力班表）

**特殊情況**：週六下午標記「輪診*」（張晉魁與楊欣達輪流），實際值班醫師每週不同，需個別確認，暫不放入 sessions。

**修正**：2026-02-18 全面改名，刪除幽靈醫師，刪除週六下午不確定時段。

---

### [c10 板橋維力] 來源分類錯誤
**問題**：CSV 將板橋維力來源標記為 `linevoom`，實際班表在 `weili-clinic.com/news/category-5/post-30`（與土城維力同一頁面）。

**修正**：2026-02-18 改 `source_type: linevoom → website`，依固定班表圖建入 13 筆 sessions，whitelist: 高逢駿、陳書佑。

---

### [c16 康澤復健科] 週四晚/週五晚/週二午錯誤
**問題**：週四晚診醫師誤為「李紹安」（應為「許哲維」）；週五晚診缺失（李紹安）；週二下午多一筆李紹安。

**修正**：2026-02-18 對照 2月月班表圖片修正。

---

### [c18 祥明診所] 週二晚/週五午缺失
**問題**：固定班表中黃有明的週二晚診、週五下午未建入。

**修正**：2026-02-18 補上兩筆，並清理 `source_note` 不一致問題。

---

### [得揚診所] cxms 日期顯示 bug
**問題**：得揚診所（c19）的 cxms 系統日期顯示有誤（例如顯示 02/18 實為 02/25）。

**處理**：每週解析時需手動比對星期幾並修正 date 欄位。屬長期已知問題。

---

## 待辦事項

### 快照歸檔
- [ ] `/home/claude/snapshots/` 目錄的快照檔移入 repo（`snapshots/` 子目錄），讓驗證紀錄版本控制

### 自動化方向
- [ ] cxms 解析腳本（`parse_cxms_all.py`）：已可運行，需整合進每週部署流程
- [ ] c15 誠陽、c21 永馨 HTML 文字可程式讀取，可考慮自動化
- [ ] c16 康澤 月份圖片 URL 有規律（含年月），可程式組 URL 再視覺解析
- [ ] FB 月班表（c09/c17/c22）：短期人工，長期可考慮 Graph API

### 每週更新 checklist
依 Spec 班表類型分類執行：
1. **週班表（9 間）**：c02~c07/c19/c20 用 cxms 抓；c21 用瀏覽器開 sc-dr 系統
2. **月班表（5 間）**：月中只換 date；月底/月初需重新取得新月份班表（c15/c16 抓網站，c09/c17/c22 看 FB 新貼文）
3. **固定班表（8 間）**：預設跳過；收到異動通知才更新

---

## 當前已知問題（下次更新時處理）

- **c01 禾安**：FB 圖片醫師名「陳柏誠醫師」帶後綴，sessions 以「陳柏誠」建入（與 whitelist 一致）；若 app 顯示異常需排查命名
- **c11/c10 輪診**：土城/板橋維力週六下午輪診，每週值班醫師不固定，需每週確認後補入
- **c12 陳正傑**：FB 貼文為 2023 固定班表，doctor_name「陳正傑」為推測，需實際到診確認

---

## 各來源技術特性

### cxms（`web.cxms.com.tw`）
- 直接 `web_fetch` 可讀，無反爬蟲
- 回傳 HTML，含醫師姓名、日期、時段
- c19 得揚診所有日期顯示 bug，解析時需手動修正

### website 來源 URL 與資料格式

| 診所 | URL | 資料格式 | 反爬蟲 | 備註 |
|------|-----|----------|--------|------|
| c10 板橋維力 | weili-clinic.com/news/category-5/post-30 | 固定班表圖片 | 無 | bash 被 proxy 封鎖，需瀏覽器 |
| c11 土城維力 | weili-clinic.com/news/category-5/post-30 | 固定班表圖片 | 無 | 同上，同頁面兩張圖 |
| c15 誠陽復健科 | sites.google.com/view/chengyang-clinic/home/門診時間 | 月曆文字（Google Sites） | 無 | 找當週那一列 |
| c16 康澤復健科 | kangzereh.com/tuchengkangzeappointment | 月班表圖片 | 無 | 圖片 URL 規律：`wp-content/uploads/YYYY/MM/NN土城康澤115年M月診表.jpg` |
| c18 祥明診所 | shiangming.com/time.php | 固定班表靜態 HTML | 無 | 幾乎不需更新 |
| c21 永馨復健科 | sc-dr.com.tw/progress/3531035027.php | 即時週班表系統 | 無 | 有「下一周」按鈕，需導覽至當週 |

### Facebook 來源

| 診所 | 粉專/貼文 URL | 班表類型 |
|------|--------------|----------|
| c01 禾安復健科 | facebook.com/share/19qBxvUV52/ | 固定（2023 貼文） |
| c09 健維骨科 | facebook.com/JianWeiGuKeZhenSuo | 月班表（每月初發文） |
| c12 陳正傑骨科 | facebook.com/share/1EwsVWdZka/ | 固定（2023 貼文，勾叉格式） |
| c17 仁祐骨科 | facebook.com/jenyuorth | 月班表（每月初發文） |
| c22 順安復健科 | facebook.com/wellnesspmr | 月班表（每月初發文） |

- bash/web_fetch 均無法讀取 FB，需瀏覽器登入存取
- 月班表診所：每月初到粉專 Posts 區找最新貼文
