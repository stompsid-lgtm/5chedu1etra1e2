# Log.md — 開發紀錄

## 已解決問題

### [圖片來源] 初次解析錯誤（c08 / c13 / c14）
**問題**：圖片診所（正陽骨科、悅滿意永和、悅滿意新店）的 sessions 錯誤，包含不在 whitelist 的醫師，且有命名錯誤。

**根本原因**：
- whitelist 過濾邏輯未在首次轉錄時執行，導致非 whitelist 醫師（蘇哲惟、曾鵬文、林醫師等）混入 sessions
- OCR 識別錯誤：c14 週三早診「羅醫師」被識別為「雞醫師」
- 悅滿意命名規則（`悅滿意江`/`悅滿意王`）中途被錯誤改為一般格式（`江醫師`/`王醫師`），導致 whitelist 比對失效

**修正**：2026-02-18 逐格重新對照圖片，刪除非 whitelist sessions，補上缺漏的週六時段，還原命名規則。

**教訓**：圖片轉錄時必須同步執行 whitelist 過濾；命名規則變更前需確認 whitelist 字串一致性。

---

### [資料衝突] 蔡馥如「週三夜診」衝突（c03 富新 vs c08 正陽）
**問題**：舊紀錄顯示蔡馥如同時出現在富新骨科（cxms）與正陽骨科（圖片）的週三夜診。

**結論**：誤讀。正陽骨科圖片中蔡馥如的班表是**週四**（下午二診＋夜間二診），不是週三。衝突不存在。

---

### [c08 whitelist] 曾鵬文誤入 whitelist
**問題**：schedules.json 的 c08 clinic 定義中，whitelist 包含 `曾鵬文`，但 CSV 來源只有 `黃英庭|黃旭東|蔡馥如`。

**修正**：2026-02-18 從 whitelist 移除 `曾鵬文`。

---

### [力康骨科] 重複時段
**問題**：力康骨科（c20）出現重複 session。

**修正**：已於上週對話修正，目前版本無重複（commit: `修正力康重複時段`）。

---

### [c11 土城維力] OCR 錯字 + 幽靈醫師
**問題**：sessions 中「張善魁」全部應為「張晉魁」（OCR 錯字）。另有「林茂森」、「陳奕成」兩位完全不在圖片班表中。

**根本原因**：首次轉錄時 OCR 將「晉」識別為「善」；林茂森/陳奕成來源不明（可能是舊週或其他診所資料混入）。

**圖片位置**：`weili-clinic.com/sites/default/files/inline-images/分頁-門診表_土城_0.png`（固定班表，115年起適用，同頁面另有板橋維力班表）

**特殊情況**：週六下午標記「輪診*」（張晉魁與楊欣達輪流），本週實際值班醫師需另行確認，暫無資料。

**修正**：2026-02-18 全面改名，刪除幽靈醫師，刪除週六下午不確定時段。

---

### [得揚診所] cxms 日期錯誤
**問題**：得揚診所（c19）的 cxms 系統顯示 02月18日，應為 02月25日（週三）。

**處理**：解析時已手動修正為正確日期，需每週監控。

---

## 待辦事項

### 資料完整性（6/22 間無資料）

| ID  | 診所       | 來源      | 狀態                                  |
|-----|------------|-----------|---------------------------------------|
| c01 | 禾安復健科 | Facebook  | 待收集                                |
| c09 | 健維骨科   | Facebook  | 待收集                                |
| c10 | 板橋維力   | Line Voom | 待截圖                                |
| c12 | 陳正傑骨科 | Facebook  | 待收集                                |
| c17 | 仁祐骨科   | Facebook  | 待收集                                |
| c22 | 順安復健科 | Facebook  | 待收集                                |

### 資料驗證（已有資料但需確認正確性）

| ID  | 診所       | 問題                                                              |
|-----|------------|-------------------------------------------------------------------|
| c11 | 土城維力   | ✓ 已驗證修正                                                      |
| c15 | 誠陽復健科 | ✓ 已驗證正確                                                      |
| c16 | 康澤復健科 | ✓ 已驗證修正（週四晚李紹安→許哲維，補週五晚李紹安，刪週二午多餘李紹安）|
| c18 | 祥明診所   | ✓ 已驗證修正（補週二晚/週五午，清理 source_note）                 |
| c21 | 永馨復健科 | ✓ 已驗證正確                                                      |

### 快照建立（驗證機制）

- [x] image 來源：c08/c13/c14 圖片已留存於上傳檔案
- [x] website 來源：c15/c16/c18/c21 快照已存於 `/home/claude/snapshots/website/`（Claude 環境，非 repo）
- [ ] website 快照移入 repo（`snapshots/` 目錄）
- [ ] c11 土城維力：確認正確 URL → 截圖快照
- [ ] Facebook 來源（c01/c09/c12/c17/c22）：初次資料收集 → 截圖快照
- [ ] Line Voom 來源（c10）：截圖快照

### 自動化方向

- [ ] cxms 解析腳本（`parse_cxms_all.py`）：已可運行，需整合進每週部署流程
- [ ] website 來源：c15/c18/c21 可程式讀取（HTML 文字），可考慮自動化；c16/c11 為圖片，需視覺解析
- [ ] Facebook / Line Voom：存取難度最高，短期維持人工，長期可考慮 Graph API（需 token 管理）

---

## 當前卡關

### c11 土城維力的班表 URL
`weili-clinic.com` 同時包含板橋與土城兩間分院的資料，但 CSV 登記的 `post-30` 頁面顯示的圖片標題是「板橋維力」。尚未確認土城維力班表的確切位置（可能在同一頁面滾動後的第二張圖，或另一篇 post）。由於 bash 環境的 egress proxy 封鎖 `weili-clinic.com`，只能透過瀏覽器工具存取。

**需要的動作**：用瀏覽器瀏覽 `post-30` 完整頁面，或找到土城維力班表的正確 URL。

---

## 各來源技術特性紀錄

### cxms（`web.cxms.com.tw`）
- 直接 `web_fetch` 可讀，無反爬蟲
- 回傳 HTML，含醫師姓名、日期、時段
- 得揚診所（c19）有日期顯示 bug，需在解析時手動修正

### website
| 診所 | URL 結構 | 資料格式 | 反爬蟲 | 備註 |
|------|----------|----------|--------|------|
| c11 土城維力 | weili-clinic.com/news/category-5/post-30 | 圖片（每週更新） | 無 | bash 環境被 proxy 封鎖，需瀏覽器 |
| c15 誠陽復健科 | sites.google.com/... | 月曆週班表文字（Google Sites） | 無 | 月曆形式，需找當週列 |
| c16 康澤復健科 | kangzereh.com/tuchengkangzeappointment | 月班表圖片，URL 含年月 | 無 | 圖片命名：`NN土城康澤115年M月診表.jpg` |
| c18 祥明診所 | shiangming.com/time.php | 固定班表靜態 HTML | 無 | 幾乎不需更新 |
| c21 永馨復健科 | sc-dr.com.tw/progress/3531035027.php | 即時週班表系統（類 cxms） | 無 | 有「下一周」按鈕，需導覽至當週 |

### Facebook
- 無 API token 無法程式讀取；需人工提供截圖或貼文文字
- 存取難度：bash/fetch 均被封鎖

### Line Voom
- 需人工截圖
- c10 板橋維力：`linevoom.line.me/user/_dRU2sRwynUYUwthLTwpRZUkS3Pl4GVHRt2DZSr8`
